!function(t){"use strict";t.module("es.widgets",["es.filters"]).directive("widgetPoll",[function(){return{restrict:"E",replace:!0,templateUrl:"app/widgets/widgets.poll.html",scope:{poll:"="},controller:["$scope",function(t){console.log("$scope",t.poll)}]}}]).constant("WEATHER_CONFIG",{meter:{high:20,low:0},places:{reigate:"33102",manchester:"28218",glasgow:"21125"},refreshInterval:54e6}).directive("widgetWeather",[function(){return{restrict:"E",replace:!0,templateUrl:"app/widgets/widgets.weather.html",controller:["$scope","WeatherFactory","WEATHER_CONFIG",function(e,a,r){var o=function(){return["Manchester","Reigate","Glasgow"][Math.round(2*Math.random())]}(),n=r.meter.high,i=r.meter.low;a.setLocation(o),e.$watch(function(){return a.weather},function(r){e.weather=a.weather,t.forEach(e.weather.forecast,function(t){n=Math.max(n,t.high),i=Math.min(i,t.low)})}),e.setMeter=function(t){var e=n-i,a=Math.max(0,(n-t.high)/e*100),r=Math.max(0,(t.low-i)/e*100);return{top:a+"%",bottom:r+"%"}}}]}}]).factory("WeatherFactory",["$q","$http","$timeout","WEATHER_CONFIG",function(t,e,a,r){var o={};o.weather={},o.location=null;var n=function(){var t="http://query.yahooapis.com/v1/public/yql?format=json&env=store://datatables.org/alltableswithkeys";t+="&q=select * from weather.forecast where woeid = "+r.places[o.location]+" and u='c'",e.get(t).success(function(t){t.query.results&&(o.weather={location:o.location,now:t.query.results.channel.item.condition,forecast:t.query.results.channel.item.forecast}),a(n(),r.refreshInterval)})};return o.setLocation=function(t){o.location=t.toLowerCase(),n()},o}]).directive("widgetStock",[function(){return{restrict:"E",replace:!0,templateUrl:"app/widgets/widgets.stock.html",controller:["$scope","$timeout","EsureStockPrice",function(t,e,a){t.data=a.data,t.$on("EsureStockPrice.update",function(){t.data=a.data}),t.$watch("data",function(){if(t.data.hasOwnProperty("history")){var e={data:{labels:t.data.history.labels,series:[t.data.history.prices]},options:{showPoint:!1,axisX:{showLabel:!1},axisY:{onlyInteger:!0},showArea:!0,chartPadding:{left:5,bottom:0}}};new Chartist.Line(".ct-chart",e.data,e.options)}})}]}}]).factory("EsureStockPrice",["$q","$http","$timeout","$rootScope",function(e,a,r,o){var n={};n.data={};var i=function(e){a.get("http://esure.jared.ph/data/stock/ESUR.json").success(function(e){n.data={time:moment(e.dataset.refreshed_at).add(12,"hours").format(),price:{current:e.dataset.data[0][1],change:{pence:e.dataset.data[0][1]-e.dataset.data[1][1],percent:100*(e.dataset.data[0][1]/e.dataset.data[1][1]-1)}},history:function(){var a={labels:[],prices:[]};return t.forEach(e.dataset.data,function(t){a.labels.splice(0,0,t[0]),a.prices.splice(0,0,t[1])}),a}()},o.$broadcast("EsureStockPrice.update")}),r(i,e)};return i(3e5),n}]).directive("widgetTrains",[function(){return{restrict:"E",replace:!0,templateUrl:"app/widgets/widgets.trains.html",controller:["$scope","TrainsFactory",function(e,a){e.trains=[],a.getLiveTrains().then(function(a){var r=moment().add(1,"hour").format("HH:mm"),o=[];t.forEach(a,function(t){t.aimed_departure_time<=r&&this.push(t)},o),e.trains=o})}]}}]).factory("TrainsFactory",["$q","$http",function(t,e){var a={};return a.getLiveTrains=function(){var a="http://transportapi.com/v3/uk/train/station/REI/live.json",r="?app_id=03bf8009&app_key=d9307fd91b0247c607e098d5effedc97&train_status=passenger",o=t.defer();return e.get(a+r).success(function(t){o.resolve(t.departures.all)}).error(function(t){o.reject(t)}),o.promise},a}])}(window.angular);
